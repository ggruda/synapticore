#!/bin/bash

# Initialize runner environment with security features

set -e

echo "ðŸš€ Initializing Synapticore Runners"
echo "===================================="
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker is not running. Please start Docker first."
    exit 1
fi

# Build runner images
echo "ðŸ“¦ Building runner images..."
./scripts/build-runners

# Create security configuration directory
echo ""
echo "ðŸ”’ Setting up security configuration..."
sudo mkdir -p /etc/runner
sudo cp runners/base/security.conf /etc/runner/security.conf
sudo chmod 644 /etc/runner/security.conf
echo "âœ… Security configuration installed"

# Create isolated network (optional - requires additional setup)
echo ""
echo "ðŸŒ Creating Docker network..."
docker network create synapticore-runner 2>/dev/null || echo "Network already exists"

# Pull base images to speed up builds
echo ""
echo "ðŸ“¥ Pre-pulling base images..."
docker pull php:8.3-cli-alpine &
docker pull node:20-alpine &
docker pull python:3.11-alpine &
docker pull golang:1.21-alpine &
docker pull eclipse-temurin:17-jdk-alpine &
wait

echo ""
echo "===================================="
echo "âœ… Runner initialization complete!"
echo ""
echo "Available commands:"
echo "  docker compose -f runners/docker-compose.yml up    # Start all runners"
echo "  php artisan runner:test-security                   # Test security features"
echo "  php artisan runner:test-security --test-dangerous  # Test dangerous command blocking"
echo ""
echo "Security features enabled:"
echo "  âœ“ Non-root user execution"
echo "  âœ“ Read-only root filesystem"
echo "  âœ“ Resource limits (CPU, Memory, PIDs)"
echo "  âœ“ Capability restrictions"
echo "  âœ“ Command validation & blocking"
echo "  âœ“ Path allowlisting"
echo "  âœ“ Output size limits"
echo "  âœ“ Rate limiting"