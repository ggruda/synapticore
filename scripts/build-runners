#!/bin/bash

# Build all runner Docker images with security features

set -e

echo "üî® Building Runner Images with Security Features"
echo "================================================"

RUNNERS_DIR="runners"
IMAGES_BUILT=0

# Copy security.conf to each runner directory
echo "üìã Copying security configuration..."
for dir in "$RUNNERS_DIR"/*/ ; do
    if [ -d "$dir" ] && [ "$dir" != "$RUNNERS_DIR/base/" ]; then
        cp "$RUNNERS_DIR/base/security.conf" "$dir/security.conf" 2>/dev/null || true
    fi
done

# Build each runner image
for dir in "$RUNNERS_DIR"/*/ ; do
    if [ -d "$dir" ] && [ "$dir" != "$RUNNERS_DIR/base/" ] && [ -f "$dir/Dockerfile" ]; then
        runner_name=$(basename "$dir")
        echo ""
        echo "üê≥ Building $runner_name runner..."
        
        if docker build -t "synapticore/runner:$runner_name" "$dir"; then
            echo "‚úÖ Successfully built $runner_name runner"
            ((IMAGES_BUILT++))
        else
            echo "‚ùå Failed to build $runner_name runner"
        fi
    fi
done

echo ""
echo "================================================"
echo "‚ú® Built $IMAGES_BUILT runner images"
echo ""
echo "Available runners:"
docker images | grep "synapticore/runner" || echo "No runner images found"
echo ""
echo "To test runners:"
echo "  docker compose -f runners/docker-compose.yml up"
echo "  php artisan runner:test-security"