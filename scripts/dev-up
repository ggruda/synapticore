#!/bin/bash
set -e

echo "ğŸš€ Starting Synapticore Development Environment..."

# Check if .env exists, if not copy from .env.example
if [ ! -f .env ]; then
    echo "ğŸ“ Creating .env file from .env.example..."
    cp .env.example .env
    
    # Generate app key
    echo "ğŸ”‘ Generating application key..."
    docker compose -f infra/compose/docker-compose.yml run --rm app php artisan key:generate
fi

# Start all services
echo "ğŸ³ Starting Docker containers..."
docker compose -f infra/compose/docker-compose.yml up -d

# Wait for database to be ready
echo "â³ Waiting for database to be ready..."
sleep 10

# Run migrations
echo "ğŸ“Š Running database migrations..."
docker compose -f infra/compose/docker-compose.yml exec app php artisan migrate --force

# Create storage link
echo "ğŸ”— Creating storage link..."
docker compose -f infra/compose/docker-compose.yml exec app php artisan storage:link

# Clear and cache config
echo "ğŸ§¹ Clearing and caching configuration..."
docker compose -f infra/compose/docker-compose.yml exec app php artisan config:clear
docker compose -f infra/compose/docker-compose.yml exec app php artisan cache:clear
docker compose -f infra/compose/docker-compose.yml exec app php artisan route:clear
docker compose -f infra/compose/docker-compose.yml exec app php artisan view:clear

# Install composer dependencies if needed
if [ ! -d "vendor" ]; then
    echo "ğŸ“¦ Installing Composer dependencies..."
    docker compose -f infra/compose/docker-compose.yml exec app composer install
fi

# Install npm dependencies if needed
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Installing NPM dependencies..."
    docker compose -f infra/compose/docker-compose.yml exec app npm ci
fi

# Build assets
echo "ğŸ¨ Building frontend assets..."
docker compose -f infra/compose/docker-compose.yml exec app npm run build

echo "âœ… Development environment is ready!"
echo ""
echo "ğŸŒ Application: http://localhost:8080"
echo "ğŸ“§ Mailpit: http://localhost:8030"
echo "ğŸ“Š Grafana: http://localhost:3000 (admin/admin)"
echo "ğŸ—„ï¸ MinIO: http://localhost:9001 (minioadmin/minioadmin123)"
echo "ğŸ“ˆ Prometheus: http://localhost:9090"
echo ""
echo "Run 'scripts/dev-logs' to view logs"
echo "Run 'scripts/dev-down' to stop all services"